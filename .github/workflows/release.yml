name: Build Release AppImage
on:
  workflow_dispatch:
  schedule:
    - cron: "5 */12 * * *"
  push:
    branches:
      - "main"
      - "stable"

jobs:
  build:
    name: Zed Release AppImage
    runs-on: ubuntu-24.04
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    outputs:
      needs_build: ${{ steps.check_update.outputs.NEEDS_BUILD }}
    steps:
      - uses: actions/checkout@v2

      - name: Get version info
        id: get_version
        run: |
          ALL_RELEASES=$(curl -sH "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/zed-industries/zed/releases)
          if [ "${{ github.ref_name }}" = "stable" ]; then
            # For stable branch, get the first stable release (non-prerelease)
            TAG=$(echo "$ALL_RELEASES" | jq -r 'map(select(.prerelease == false)) | first | .tag_name')
            DATE=$(echo "$ALL_RELEASES" | jq -r 'map(select(.prerelease == false)) | first | .published_at')
            [ -z "$TAG" ] && { echo "No stable release found"; exit 1; }
          else
            # For other branches (main), get pre-release
            TAG=$(echo "$ALL_RELEASES" | jq -r 'map(select(.prerelease)) | first | .tag_name')
            DATE=$(echo "$ALL_RELEASES" | jq -r 'map(select(.prerelease)) | first | .published_at')
            [ -z "$TAG" ] && { echo "No pre-release found"; exit 1; }
          fi
          VERSION=$(echo "$TAG" | sed 's/^v//')
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "DATE_EPOCH=$(date -d "$DATE" +%s 2>/dev/null || date -d '2020-01-01' +%s)" >> $GITHUB_OUTPUT

      - name: Check for existing release
        id: check_update
        run: |
          LATEST=$(curl -sH "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/releases/tags/latest || true)
          if echo "$LATEST" | grep -q '"tag_name":"latest"'; then
            EXISTING=$(echo "$LATEST" | jq -r '.body' | grep -oP 'Zed version: \K[0-9.]+' || echo "none")
            [ "$EXISTING" = "${{ steps.get_version.outputs.VERSION }}" ] && \
              { echo "NEEDS_BUILD=false" >> $GITHUB_OUTPUT; exit 0; }
          fi
          echo "NEEDS_BUILD=true" >> $GITHUB_OUTPUT
          echo "APP_NAME=Zed" >> $GITHUB_ENV
          echo "APP_VERSION=${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_ENV

      - name: Install dependencies
        if: steps.check_update.outputs.NEEDS_BUILD == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y squashfs-tools libfuse2 wget jq gh

      - name: Download & prepare Zed with retry and validation
        if: steps.check_update.outputs.NEEDS_BUILD == 'true'
        env:
          TZ: UTC
          SOURCE_DATE_EPOCH: ${{ steps.get_version.outputs.DATE_EPOCH }}
        run: |
          # Download with retry
          for i in {1..3}; do
            if wget -q "https://github.com/zed-industries/zed/releases/download/${{ steps.get_version.outputs.TAG }}/zed-linux-x86_64.tar.gz"; then
              break
            elif [ $i -eq 3 ]; then
              echo "Failed to download after 3 attempts"
              exit 1
            fi
            sleep 5
          done
          
          # Verify download
          if [ ! -f zed-linux-x86_64.tar.gz ]; then
            echo "Download failed - archive not found"
            exit 1
          fi
          echo "Downloaded archive size: $(ls -lah zed-linux-x86_64.tar.gz | awk '{print $5}')"
          
          tar -xzf zed-linux-x86_64.tar.gz --mtime='2020-01-01 00:00:00'
          
          # Handle different directory structures for stable vs preview releases
          if [ "${{ github.ref_name }}" = "stable" ]; then
            # Stable releases use zed.app
            mv zed.app AppDir
          else
            # Preview releases use zed-preview.app
            mv zed-preview.app AppDir
          fi
          
          rm zed-linux-x86_64.tar.gz
          
          # Handle different desktop file names
          if [ "${{ github.ref_name }}" = "stable" ]; then
            # Stable releases use zed.desktop
            mv AppDir/share/applications/zed.desktop AppDir/share/applications/zed.desktop.bak || true
          else
            # Preview releases use zed-preview.desktop
            mv AppDir/share/applications/zed-preview.desktop AppDir/share/applications/zed.desktop || true
            sed -i 's/Name=zed-preview/Name=Zed/' AppDir/share/applications/zed.desktop || true
            sed -i 's/Exec=zed-preview/Exec=zed/' AppDir/share/applications/zed.desktop || true
          fi
          cp AppDir/share/applications/zed.desktop AppDir/ || true
          cp AppDir/share/icons/hicolor/512x512/apps/zed.png AppDir/ || true
          cd AppDir && ln -sf bin/zed AppRun && cd ..
          find AppDir -type f -o -type d | sort | xargs touch -t 202001010000.00

      - name: Prepare output directory & debug
        if: steps.check_update.outputs.NEEDS_BUILD == 'true'
        run: |
          mkdir -p dist
          echo "AppDir listing:"
          ls -al AppDir || true
          echo "dist listing (before build):"
          ls -al dist || true

      - name: Build AppImage with modern options
        if: steps.check_update.outputs.NEEDS_BUILD == 'true'
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          
          # Use different update info for stable vs preview
          if [ "${{ github.ref_name }}" = "stable" ]; then
            Update_Info="gh-releases-zsync|${{ github.repository_owner }}|${{ github.event.repository.name }}|stable|Zed-x86_64.AppImage.zsync"
          else
            Update_Info="gh-releases-zsync|${{ github.repository_owner }}|${{ github.event.repository.name }}|latest|Zed-x86_64.AppImage.zsync"
          fi
          
          # Use different output filenames for stable vs preview
          if [ "${{ github.ref_name }}" = "stable" ]; then
            OUTPUT_FILE="dist/Zed-Stable-x86_64.AppImage"
          else
            OUTPUT_FILE="dist/Zed-Preview-x86_64.AppImage"
          fi
          
          ./appimagetool-x86_64.AppImage \
            -u "$Update_Info" \
            --comp xz \
            --verbose \
            AppDir \
            "$OUTPUT_FILE"

      - name: Verify and validate AppImage
        if: steps.check_update.outputs.NEEDS_BUILD == 'true'
        run: |
          echo "dist contents after build:"
          ls -al dist
          # Check for the correct AppImage file based on branch
          if [ "${{ github.ref_name }}" = "stable" ]; then
            test -f dist/Zed-Stable-x86_64.AppImage || (echo "Stable AppImage missing" && exit 1)
          else
            test -f dist/Zed-Preview-x86_64.AppImage || (echo "Preview AppImage missing" && exit 1)
          fi
          
          # Debug: Check for zsync file in all possible locations
          echo "Searching for zsync file in current directory:"
          find . -name "*.zsync" -type f
          echo "Searching for zsync file in dist directory:"
          find dist -name "*.zsync" -type f 2>/dev/null || echo "No zsync file found in dist directory"
          echo "Listing all files in working directory:"
          find . -maxdepth 2 -type f -name "*.zsync" -exec ls -la {} \;
          
          # Validate zsync generation with correct filename
          if [ "${{ github.ref_name }}" = "stable" ]; then
            ZSYNC_FILE="dist/Zed-Stable-x86_64.AppImage.zsync"
          else
            ZSYNC_FILE="dist/Zed-Preview-x86_64.AppImage.zsync"
          fi
          
          if [ ! -f "$ZSYNC_FILE" ]; then
            echo "zsync file was not generated in dist/ directory!"
            # Try to find the zsync file in case it was generated elsewhere
            if [ "${{ github.ref_name }}" = "stable" ]; then
              FOUND_ZSYNC=$(find . -name "Zed-Stable-x86_64.AppImage.zsync" -type f | head -n 1)
            else
              FOUND_ZSYNC=$(find . -name "Zed-Preview-x86_64.AppImage.zsync" -type f | head -n 1)
            fi
            if [ -n "$FOUND_ZSYNC" ]; then
              echo "zsync file found at: $FOUND_ZSYNC"
              cp "$FOUND_ZSYNC" dist/ || echo "Failed to copy zsync file to dist directory"
              if [ -f "$ZSYNC_FILE" ]; then
                echo "zsync file successfully copied to dist/ directory"
              else
                echo "Failed to copy zsync file to dist directory"
                exit 1
              fi
            else
              echo "No zsync file found in any location"
              exit 1
            fi
          fi
          echo "zsync file size: $(ls -lah "$ZSYNC_FILE" | awk '{print $5}')"
          echo "zsync file found and validated"
          
          # Make AppImage executable and do basic validation
          if [ "${{ github.ref_name }}" = "stable" ]; then
            APPIMAGE_FILE="dist/Zed-Stable-x86_64.AppImage"
          else
            APPIMAGE_FILE="dist/Zed-Preview-x86_64.AppImage"
          fi
          
          chmod +x "$APPIMAGE_FILE"
          
          # Test if AppImage can show help (non-interactive)
          timeout 15 ./"$APPIMAGE_FILE" --help > /dev/null 2>&1 || echo "Help check completed (expected timeout)"
          
          echo "AppImage validation completed successfully"
          echo "AppImage size: $(ls -lah "$APPIMAGE_FILE" | awk '{print $5}')"

      - name: Upload release (gh)
        if: steps.check_update.outputs.NEEDS_BUILD == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Build the list of files to upload: always upload the correct AppImage, include zsync if present
          if [ "${{ github.ref_name }}" = "stable" ]; then
            FILES="dist/Zed-Stable-x86_64.AppImage"
            [ -f dist/Zed-Stable-x86_64.AppImage.zsync ] && FILES="$FILES dist/Zed-Stable-x86_64.AppImage.zsync"
          else
            FILES="dist/Zed-Preview-x86_64.AppImage"
            [ -f dist/Zed-Preview-x86_64.AppImage.zsync ] && FILES="$FILES dist/Zed-Preview-x86_64.AppImage.zsync"
          fi
          
          # Verify all files exist before upload
          for file in $FILES; do
            if [ ! -f "$file" ]; then
              echo "File $file does not exist for upload"
              exit 1
            fi
          done
          
          echo "Files to upload: $FILES"
          
          # Determine which release to delete based on branch
          if [ "${{ github.ref_name }}" = "stable" ]; then
            RELEASE_TAG="stable"
          else
            RELEASE_TAG="latest"
          fi
          
          # Delete existing release if present, then create new one with explicit files.
          # Add retry for release operations
          for i in {1..3}; do
            if gh release delete "$RELEASE_TAG" --yes 2>/dev/null || true; then
              break
            elif [ $i -eq 3 ]; then
              echo "Failed to delete existing release after 3 attempts"
            fi
            sleep 5
          done
          
          # Use different release tags for stable vs preview
          if [ "${{ github.ref_name }}" = "stable" ]; then
            RELEASE_TAG="stable"
            RELEASE_TITLE="Zed Stable AppImage ${{ env.APP_VERSION }}"
          else
            RELEASE_TAG="latest"
            RELEASE_TITLE="Zed Preview AppImage ${{ env.APP_VERSION }}"
          fi
          
          for i in {1..3}; do
            if gh release create "$RELEASE_TAG" \
              --title "$RELEASE_TITLE" \
              --notes "Zed version: ${{ env.APP_VERSION }}" \
              -- $FILES; then
              break
            elif [ $i -eq 3 ]; then
              echo "Failed to create release after 3 attempts"
              exit 1
            fi
            sleep 5
          done

      - name: Post-release debug (optional)
        if: steps.check_update.outputs.NEEDS_BUILD == 'true'
        run: |
          echo "Final dist listing:"
          ls -al dist || true
