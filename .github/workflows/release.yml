name: Build Release AppImage
on:
  workflow_dispatch:
  schedule:
    - cron: "5 */12 * * *"
  push:
    branches:
      - "main"

jobs:
  build:
    name: Zed Release AppImage
    runs-on: ubuntu-24.04
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    outputs:
      needs_build: ${{ steps.check_update.outputs.NEEDS_BUILD }}
    steps:
      - uses: actions/checkout@v2
      
      - name: Get version info
        id: get_version
        run: |
          ALL_RELEASES=$(curl -sH "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/zed-industries/zed/releases)
          TAG=$(echo "$ALL_RELEASES" | jq -r 'map(select(.prerelease)) | first | .tag_name')
          DATE=$(echo "$ALL_RELEASES" | jq -r 'map(select(.prerelease)) | first | .published_at')
          
          [ -z "$TAG" ] && { echo "No pre-release found"; exit 1; }
          
          VERSION=$(echo "$TAG" | sed 's/^v//')
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "DATE_EPOCH=$(date -d "$DATE" +%s 2>/dev/null || date -d '2020-01-01' +%s)" >> $GITHUB_OUTPUT

      - name: Check for existing release
        id: check_update
        run: |
          LATEST=$(curl -sH "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/releases/tags/latest || true)
          
          if echo "$LATEST" | grep -q '"tag_name":"latest"'; then
            EXISTING=$(echo "$LATEST" | jq -r '.body' | grep -oP 'Zed version: \K[0-9.]+' || echo "none")
            [ "$EXISTING" = "${{ steps.get_version.outputs.VERSION }}" ] && \
              { echo "NEEDS_BUILD=false" >> $GITHUB_OUTPUT; exit 0; }
          fi
          
          echo "NEEDS_BUILD=true" >> $GITHUB_OUTPUT
          echo "APP_NAME=Zed" >> $GITHUB_ENV
          echo "APP_VERSION=${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_ENV

      - name: Install dependencies
        if: steps.check_update.outputs.NEEDS_BUILD == 'true'
        run: sudo apt-get update && sudo apt-get install -y libfuse2t64

      - name: Download & prepare Zed
        if: steps.check_update.outputs.NEEDS_BUILD == 'true'
        env:
          SOURCE_DATE_EPOCH: ${{ steps.get_version.outputs.DATE_EPOCH }}
          TZ: UTC
        run: |
          wget -q "https://github.com/zed-industries/zed/releases/download/${{ steps.get_version.outputs.TAG }}/zed-linux-x86_64.tar.gz"
          
          # Extract the tarball
          tar -xzf zed-linux-x86_64.tar.gz --mtime='2020-01-01 00:00:00'
          
          # Rename to AppDir
          mv zed-preview.app AppDir
          rm zed-linux-x86_64.tar.gz
          
          # Handle desktop file for preview builds
          mv AppDir/share/applications/zed-preview.desktop AppDir/share/applications/zed.desktop
          sed -i 's/Name=zed-preview/Name=Zed/' AppDir/share/applications/zed.desktop
          sed -i 's/Exec=zed-preview/Exec=zed/' AppDir/share/applications/zed.desktop
          
          # CRITICAL FIX: Copy desktop file to AppDir root (where appimagetool expects it)
          cp AppDir/share/applications/zed.desktop AppDir/
          
          # Create AppRun symlink
          cd AppDir && ln -sf bin/zed AppRun && cd ..
          
          # Verify structure
          ls -la AppDir/
          [ -f AppDir/bin/zed ] || { echo "zed binary missing"; exit 1; }
          [ -f AppDir/zed.desktop ] || { echo "desktop file missing at root"; exit 1; }
          
          # Set deterministic timestamps
          find AppDir -type f -o -type d | sort | xargs touch -t 202001010000.00

      - name: Build AppImage
        if: steps.check_update.outputs.NEEDS_BUILD == 'true'
        env:
          SOURCE_DATE_EPOCH: ${{ steps.get_version.outputs.DATE_EPOCH }}
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          
          UPDATE_INFO="gh-releases-zsync|${{ github.repository_owner }}|${{ github.event.repository.name }}|latest|Zed-x86_64.AppImage.zsync"
          
          ./appimagetool-x86_64.AppImage \
            -u "$UPDATE_INFO" \
            --comp xz \
            AppDir \
            dist/Zed-x86_64.AppImage

      - name: Release
        if: steps.check_update.outputs.NEEDS_BUILD == 'true'
        uses: marvinpinto/action-automatic-releases@latest
        with:
          title: "${{ env.APP_NAME }} AppImage ${{ env.APP_VERSION }}"
          automatic_release_tag: latest
          prerelease: false
          body: "Zed version: ${{ env.APP_VERSION }}"
          files: dist/*
          repo_token: ${{ secrets.GITHUB_TOKEN }}