name: Build Release AppImage

on:
  workflow_dispatch:
  schedule:
    - cron: "5 */12 * * *"
  push:
    branches:
      - "main"

jobs:
  version:
    name: Zed Release AppImage
    runs-on: ubuntu-24.04
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v2
      
      - name: Set up directories and get version info
        id: get_zed_version
        run: |
          mkdir -p AppDir/usr/bin
          # Fetch all releases and find the latest pre-release
          ALL_RELEASES=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/zed-industries/zed/releases)
          VERSION_TAG=$(echo "$ALL_RELEASES" | jq -r 'map(select(.prerelease)) | first | .tag_name')
          RELEASE_DATE=$(echo "$ALL_RELEASES" | jq -r 'map(select(.prerelease)) | first | .published_at')

          if [ -z "$VERSION_TAG" ]; then
            echo "Error: No pre-release found."
            exit 1
          fi

          VERSION=$(echo "$VERSION_TAG" | sed 's/^v//')
          echo "{\"version\": \"$VERSION\"}" > AppDir/usr/bin/version.json
          echo "VERSION_TAG=$VERSION_TAG" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          # Convert to epoch time, fallback to fixed date if parsing fails
          RELEASE_DATE_EPOCH=$(date -d "$RELEASE_DATE" +%s 2>/dev/null || date -d '2020-01-01' +%s)
          echo "RELEASE_DATE=$RELEASE_DATE_EPOCH" >> $GITHUB_OUTPUT

      - name: Check if update needed
        id: check_update
        run: |
          # Check if this version is already released
          LATEST_RELEASE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/releases/tags/latest || echo "")
          
          if echo "$LATEST_RELEASE" | grep -q '"tag_name":"latest"'; then
            EXISTING_VERSION=$(echo "$LATEST_RELEASE" | jq -r '.body' | grep -oP 'Zed version: \K[0-9.]+' || echo "none")
            if [ "$EXISTING_VERSION" = "${{ steps.get_zed_version.outputs.VERSION }}" ]; then
              echo "Update not needed, version ${{ steps.get_zed_version.outputs.VERSION }} already released"
              echo "NEEDS_BUILD=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          echo "NEEDS_BUILD=true" >> $GITHUB_OUTPUT
          echo "APP_NAME=Zed" >> $GITHUB_ENV
          echo "APP_VERSION=${{ steps.get_zed_version.outputs.VERSION }}" >> $GITHUB_ENV

      - name: Install dependencies
        if: steps.check_update.outputs.NEEDS_BUILD == 'true'
        run: |
          sudo add-apt-repository universe
          sudo apt-get update
          sudo apt-get install -y libfuse2t64

      - name: Download Zed release
        if: steps.check_update.outputs.NEEDS_BUILD == 'true'
        run: |
          wget -q "https://github.com/zed-industries/zed/releases/download/${{ steps.get_zed_version.outputs.VERSION_TAG }}/zed-linux-x86_64.tar.gz"
          
      - name: Prepare AppDir
        if: steps.check_update.outputs.NEEDS_BUILD == 'true'
        run: |
          # Create base AppDir structure
          mkdir -p AppDir/usr/bin
          
          # Download and extract to temp directory first
          wget -q "https://github.com/zed-industries/zed/releases/download/${{ steps.get_zed_version.outputs.VERSION_TAG }}/zed-linux-x86_64.tar.gz"
          
          # Extract without strip-components to inspect actual structure
          mkdir -p temp_extract
          tar -xzf zed-linux-x86_64.tar.gz -C temp_extract --mtime='2020-01-01 00:00'
          
          echo "=== Extracted structure ==="
          find temp_extract -type f -executable | head -10
          
          # Look for the zed binary
          ZED_BINARY=$(find temp_extract -name "zed" -type f -executable | head -1)
          
          if [ -z "$ZED_BINARY" ]; then
            echo "Error: zed binary not found in tarball"
            echo "All files:"
            find temp_extract -type f
            exit 1
          fi
          
          # Copy everything to AppDir/usr/bin, preserving structure
          cp -r temp_extract/* AppDir/usr/bin/ 2>/dev/null || true
          
          # Clean up
          rm -rf temp_extract
          
          # Verify binary exists and is executable
          if [ ! -f AppDir/usr/bin/zed ]; then
            # Try alternative paths
            if [ -f AppDir/usr/bin/bin/zed ]; then
              # Structure has bin subdirectory
              mv AppDir/usr/bin/bin/* AppDir/usr/bin/
              rmdir AppDir/usr/bin/bin 2>/dev/null || true
            fi
          fi
          
          if [ ! -f AppDir/usr/bin/zed ]; then
            echo "Error: zed binary not found. Contents of AppDir/usr/bin/:"
            ls -la AppDir/usr/bin/
            exit 1
          fi
          
          chmod +x AppDir/usr/bin/zed
          
          # Create desktop file
          mkdir -p AppDir/usr/share/applications
          cat > AppDir/usr/share/applications/zed.desktop <<EOF
          [Desktop Entry]
          Version=1.0
          Name=Zed
          Comment=High-performance code editor
          Exec=zed
          Icon=zed
          Type=Application
          Categories=Development;TextEditor;IDE;
          Terminal=false
          EOF
          
          # Handle icon
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          # Try to find icon in extracted files or download default
          if [ -f AppDir/usr/bin/zed.png ]; then
            cp AppDir/usr/bin/zed.png AppDir/usr/share/icons/hicolor/256x256/apps/
          else
            wget -q -O AppDir/usr/share/icons/hicolor/256x256/apps/zed.png \
              https://raw.githubusercontent.com/zed-industries/zed/main/crates/zed/resources/app-icon@2x.png || \
            touch AppDir/usr/share/icons/hicolor/256x256/apps/zed.png
          fi
          
          # Set deterministic permissions and timestamps
          find AppDir -type f | sort | xargs chmod 644
          find AppDir -type d | sort | xargs chmod 755
          find AppDir -type f -o -type d | sort | xargs touch -t 202001010000.00
          
          # Create AppRun symlink
          cd AppDir
          ln -sf usr/bin/zed AppRun
          cd ..

      - name: Download appimagetool
        if: steps.check_update.outputs.NEEDS_BUILD == 'true'
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Create deterministic AppImage
        if: steps.check_update.outputs.NEEDS_BUILD == 'true'
        env:
          SOURCE_DATE_EPOCH: ${{ steps.get_zed_version.outputs.RELEASE_DATE }}
          TZ: UTC
        run: |
          # Generate update information - critical for delta updates
          UPDATE_INFO="gh-releases-zsync|${{ github.repository_owner }}|${{ github.event.repository.name }}|latest|Zed-x86_64.AppImage.zsync"
          
          ./appimagetool-x86_64.AppImage \
            -u "$UPDATE_INFO" \
            --comp xz \
            AppDir \
            dist/Zed-x86_64.AppImage

      - name: Verify artifacts
        if: steps.check_update.outputs.NEEDS_BUILD == 'true'
        run: |
          ls -lh dist/
          [ -f dist/Zed-x86_64.AppImage ] || exit 1
          [ -f dist/Zed-x86_64.AppImage.zsync ] || exit 1

      - name: Upload artifact
        if: steps.check_update.outputs.NEEDS_BUILD == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: Zed-AppImage-artifacts
          path: |
            dist/*.AppImage
            dist/*.zsync

      - name: Create Release
        if: steps.check_update.outputs.NEEDS_BUILD == 'true'
        uses: marvinpinto/action-automatic-releases@latest
        with:
          title: "Zed AppImage ${{ env.APP_VERSION }}"
          automatic_release_tag: latest
          prerelease: false
          body: "Zed version: ${{ env.APP_VERSION }}"
          files: |
            dist/*.AppImage
            dist/*.zsync
          repo_token: ${{ secrets.GITHUB_TOKEN }}